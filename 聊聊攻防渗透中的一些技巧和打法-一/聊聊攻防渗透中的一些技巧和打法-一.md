---
title: 聊聊攻防渗透中的一些技巧和打法（一）
url: https://mp.weixin.qq.com/s?__biz=Mzg3NDk3NzMwNw==&mid=2247484413&idx=1&sn=bf8f146866cbd8ba5c37c4a2f8d4ff32&chksm=cec9c289f9be4b9ff3d773b0847fb75f1bd17618b09cc66c114736c88b690db7cb9a865176d7&mpshare=1&scene=1&srcid=0216xCQUUmzvaUl97vORtLQp&sharer_shareinfo=ab9ba5d4d416375e8c424b82517c82b2&sharer_shareinfo_first=ab9ba5d4d416375e8c424b82517c82b2#rd
clipped_at: 2024-03-31 19:57:14
category: temp
tags: 
 - mp.weixin.qq.com
---


# 聊聊攻防渗透中的一些技巧和打法（一）

    

  

  

**01**

**特殊情况下的Agent内存马  
**

  

日常渗透打点有时候会遇到一些不太常见的情况，就是找到一个点，可以命令执行，但是是由于网络策略的原因，反向不出网，没法直接上线Cobaltstrike(假设出网，大部分时候就是直接执行远程下载落地，执行自身上线)，并且这个web应用是jar包启动的（俗称的**JAVA微服务架构**就是这个），这就导致无论正向写webshell或者反向反弹shell都不是很好操作。

因此引入了Java Agent内存马用于解决这个问题。

首先，我们都知道Java是一种静态强类型语言，在运行之前必须将其编译成.class字节码，然后再交给JVM处理运行。Java Agent 就是一种能在不影响正常编译的前提下，修改 Java 字节码，进而动态地修改已加载或未加载的类、属性和方法的技术。

简而言之，就是通过命令执行将恶意类注册为Agent代理，这里的恶意类就包含我们常用的webshell，正向webshell代理，比如Suo5,Neo-reGeorg等基于webshell的不出网代理。

接下来，用一个场景举例：

由于专门做一个环境略微麻烦，笔者就直接在命令行里示例，这个环境是idocv的漏洞环境：

![图片](assets/1711886234-620ae2b3a08de63daba64042038d6544.webp)

这里使用Agent内存马注入，我们可以使用工具 Vagent

相关说明如下：

![图片](assets/1711886234-41af1d40258be7acd6f6929ea1f4ccb2.webp)

![图片](assets/1711886234-5052ec32a22ff819085bbc30688ec816.webp)

以上，我们在cmd中模拟命令执行的效果：  

![图片](assets/1711886234-aa17a69fd04051653db57348d1cab096.webp)

如图，返回id，即为注入成功

![图片](assets/1711886234-eebe58328218d363a3d37f5e4d15f591.webp)

访问内存马，也是返回200，证明注入成功的，这里连接一下代理，验证是否可用：

![图片](assets/1711886234-2698a36741052b1d8da63752add96772.webp)

证明可用

  

  

  

**02**

**

# Vcenter的常见打法

**

### 

  

企业中用VMware vCenter管控EXSI虚拟机是很常见的情况。大多数攻防场景下，并不是说你控下了Vcenter就算你控下了所有机器，裁判需要你证明可以控制vcenter内的虚拟机才可以。

这就涉及到需要登录vCenter控制台，而一般vCenter的密码是随机生成的，非常非常复杂（18位往上），因此就需要下载vCenter的数据库文件，从中生成可用cookie进而进入控制台。

这里使用漏洞直接打入webshell  

![图片](assets/1711886234-8d30619a2ecf6e0a1611393e4015794e.webp)

接下来下载data.mdb文件（该文件位于服务器目录下，位置不唯一，自行查找），使用vcenter\_saml\_login.py生成Cookie登录系统：  

工具自取：https://github.com/horizon3ai/vcenter\_saml\_login  
  

红框就是生成的cookie，将访问控制台的Cookie改为新生成的Cookie，访问https://vcenter.chaos-example.com/ui/即可（这个域名仅举例说明，非实际域名地址，这个需要根据内网自动跳转的域名修改）  

这里还涉及一步操作，就是需要将vcenter的host指向Vcenter的内网IP地址(因为内网访问Vcenter大多数情况会直接跳转内网域名，但是由于内网DNS并不知道，所以就会出现不修改本机域名指向就无法访问的情况)  

  
  

比如我这里是修改本机的Host文件，使得vcenter.chaos-example.com指向192.168.1.1

刷新页面，如下：  

![图片](assets/1711886234-4db7b80cefbf15b422cb16cb2cd87d33.webp)  

即为进入Vcenter的控制台，可以统计具体的虚拟机数量（以及通过克隆虚拟机提取内存，获取内存中保存的windows密码），就不演示了，详情自行研究。  

  

  

  

  

  

**03**

# **关于zabbix上线的打法**

  

zabbix是一个很常见的运维工具：

很多时候会碰到运维人员正在使用zabbix，未退出的情况(或者有时候运气好也有弱口令)，这时候又想控制zabbix agent下的机器，可以使用zabbix下发脚本命令执行的功能：

一般是在http://127.0.0.1/zabbix.php?action=script.list这里

![图片](assets/1711886234-4f17f42a88194758be12bb40533005fb.webp)

例如：

写了一段下载后上线的命令：

![图片](assets/1711886234-4fe1967e3b8325107bf0695813ea2abd.webp)

执行上线

![图片](assets/1711886234-3b7740bc00d0b2924f778685e0a34ea0.webp)

笔者只是举例，上线的工具笔者是用的CS，当然用其他远控工具也是可以的，不要局限。

  

  

  

  

**04**

**

后话  


**

  

  

照例说两句，祝大家新年快乐，万事如意！